# 点加运算（Point Addition）

点加运算（Point Addition）是椭圆曲线密码学（ECC, Elliptic Curve Cryptography）中最基本的运算之一。它定义了如何将椭圆曲线上的两个点“相加”得到第三个点，这个运算是构建 ECC 安全性的核心。

## 一、椭圆曲线的基本形式

我们通常使用 **素数域** $ \mathbb{F}_p $ 上的短 Weierstrass 形式椭圆曲线：

$$
E: y^2 \equiv x^3 + ax + b \pmod{p}
$$

其中：
- $ p $ 是一个大素数（如 secp256k1 中 $ p = 2^{256} - 2^{32} - 977 $）
- $ a, b \in \mathbb{F}_p $，且满足 $ 4a^3 + 27b^2 \not\equiv 0 \pmod{p} $（保证曲线非奇异）

曲线上所有满足该方程的点 $ (x, y) $，加上一个特殊点 **无穷远点** $ \mathcal{O} $（也叫“零点”或“单位元”），构成一个**阿贝尔群**（Abelian group）。点加就是这个群的加法运算。

## 二、点加的几何直观（实数域上）

虽然实际 ECC 在有限域上运算，但几何图像有助于理解：

1. **两点不同（P ≠ Q）**：
   - 连接 P 和 Q 画一条直线；
   - 该直线与曲线交于第三点 R'；
   - 将 R' 关于 x 轴对称，得到 R = P + Q。

2. **两点相同（P = Q，即点倍）**：
   - 在 P 点作切线；
   - 切线与曲线交于另一点 R'；
   - 对称得到 R = 2P。

3. **特殊情况**：
   - 如果 P = -Q（即 x 相同，y 互为相反数），则 P + Q = $ \mathcal{O} $（无穷远点）。
   - 任何点加 $ \mathcal{O} $ 都等于自身：$ P + \mathcal{O} = P $。

> 在有限域中没有“画图”，但代数公式完全对应上述几何规则。

## 三、点加的代数公式（仿射坐标，Affine Coordinates）

设：
- $ P = (x_1, y_1) $
- $ Q = (x_2, y_2) $
- $ R = P + Q = (x_3, y_3) $

### 情况 1：P ≠ Q（普通点加）

若 $ x_1 \ne x_2 $，则：

$$
\lambda = \frac{y_2 - y_1}{x_2 - x_1} \mod p
$$
$$
x_3 = \lambda^2 - x_1 - x_2 \mod p
$$
$$
y_3 = \lambda(x_1 - x_3) - y_1 \mod p
$$

> 注意：除法在模 p 下 = 乘以分母的**模逆元**，即  
> $ \frac{a}{b} \mod p = a \cdot b^{-1} \mod p $

### 情况 2：P = Q（点倍，Doubling）

若 $ P = Q $ 且 $ y_1 \ne 0 $，则：

$$
\lambda = \frac{3x_1^2 + a}{2y_1} \mod p
$$
$$
x_3 = \lambda^2 - 2x_1 \mod p
$$
$$
y_3 = \lambda(x_1 - x_3) - y_1 \mod p
$$

### 情况 3：特殊情况

| 条件 | 结果 |
|------|------|
| $ P = \mathcal{O} $ | $ P + Q = Q $ |
| $ Q = \mathcal{O} $ | $ P + Q = P $ |
| $ x_1 = x_2 $ 且 $ y_1 = -y_2 \mod p $ | $ P + Q = \mathcal{O} $ |
| $ P = Q $ 且 $ y_1 = 0 $ | $ 2P = \mathcal{O} $（切线垂直）|

## 四、举个例子（小素数域）

曲线：$ y^2 = x^3 + x + 1 \mod 23 $（即 $ a=1, b=1, p=23 $）

取两点：
- $ P = (3, 10) $
- $ Q = (9, 7) $

验证它们在曲线上：
- $ 10^2 = 100 \equiv 8 \mod 23 $
- $ 3^3 + 3 + 1 = 27 + 3 + 1 = 31 \equiv 8 \mod 23 $ ✅

计算 $ R = P + Q $：

1. $ \lambda = (7 - 10) / (9 - 3) = (-3) / 6 \mod 23 $
2. $ -3 \mod 23 = 20 $，$ 6^{-1} \mod 23 = ? $
   - 因为 $ 6 \times 4 = 24 \equiv 1 \mod 23 $，所以 $ 6^{-1} = 4 $
3. $ \lambda = 20 \times 4 = 80 \equiv 11 \mod 23 $
4. $ x_3 = 11^2 - 3 - 9 = 121 - 12 = 109 \equiv 109 \mod 23 = 109 - 4×23 = 109 - 92 = 17 $
5. $ y_3 = 11(3 - 17) - 10 = 11(-14) - 10 = -154 - 10 = -164 $
   - $ -164 \mod 23 $:  
     $ 23×8 = 184 $, $ -164 + 184 = 20 $
   - 所以 $ y_3 = 20 $

✅ 结果：$ R = (17, 20) $

验证：  
$ 20^2 = 400 \equiv 400 - 17×23 = 400 - 391 = 9 \mod 23 $  
$ 17^3 + 17 + 1 = 4913 + 18 = 4931 $  
$ 4931 \div 23 = 214×23 = 4922 $, 余数 = 9 ✅

## 五、硬件实现中的挑战

1. **模逆元昂贵**：除法 → 需要扩展欧几里得算法或费马小定理（$ a^{-1} = a^{p-2} \mod p $），计算慢。
2. **解决方案**：使用**投影坐标**（如 Jacobian 坐标），将点表示为 $ (X, Y, Z) $，避免除法，最后再转回仿射坐标。
3. **大整数运算**：256 位加/乘/模需要专用硬件单元。

## 总结

点加运算是 ECC 的基石，其规则由椭圆曲线的代数结构决定。虽然公式简洁，但在有限域上高效安全地实现它（尤其在硬件中）是 ECC 工程的核心难点。
