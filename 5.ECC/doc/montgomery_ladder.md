# Montgomery Ladder

**Montgomery Ladder** 是椭圆曲线标量乘法（Scalar Multiplication）中最经典、最安全的算法之一，因其 **恒定时间执行（constant-time）** 特性，被广泛用于抗侧信道攻击（如时序分析、功耗分析）的安全实现中。

## 1. 为什么叫 "Montgomery" Ladder？

- 由 **Peter L. Montgomery** 在 1987 年提出（最初用于整数模幂）
- 后被适配到椭圆曲线（ECC）
- 名称中的 “Ladder” 源于其 **两个寄存器交替更新** 的结构，像爬梯子一样


## 2. 核心思想

给定：
- 标量 $ k = (k_{n-1}, k_{n-2}, \dots, k_0)_2 \in \mathbb{N} $
- 基点 $ G $ 在椭圆曲线上

目标：计算 $ Q = k \cdot G $

### 关键特性：
> **无论 $ k_i = 0 $ 或 $ 1 $，每轮都执行相同的操作序列（1 次点加 + 1 次点倍）**

→ 攻击者无法通过功耗/时序推断密钥比特！

## 3. 算法伪代码（从高位到低位）

```text
Input:  k = (k_{n-1}, ..., k_0)_2,  G ≠ O
Output: Q = k·G

// 初始化
R0 = O        // 无穷远点
R1 = G

// 找到最高有效位（MSB）
i = n - 1
while i ≥ 0 and k[i] == 0:
    i = i - 1
if i < 0: return O

// 从 MSB-1 开始处理（因为 R1 已设为 G）
for j from i-1 downto 0:
    if k[j] == 0:
        R1 = R0 + R1   // 点加
        R0 = 2·R0      // 点倍
    else:
        R0 = R0 + R1   // 点加
        R1 = 2·R1      // 点倍

return R0
```

> 注意：有些变体从 MSB 开始（包括 MSB），但需调整初始值。上述是更常见的形式。


## 4. 为什么它正确？—— 不变量（Invariant）

在每轮循环开始前，始终满足：
$$
(R_0, R_1) = (m \cdot G,\ (m+1) \cdot G)
$$
其中 $ m $ 是当前已处理的标量前缀。

### 举例：$ k = 1101_2 = 13 $

| 步骤 | 已处理比特 | m | R0 = m·G | R1 = (m+1)·G | k[j] | 操作 |
|------|-----------|----|--------|------------|------|------|
| 初始 | -         | 1  | O      | G          | -    | 设 R0=O, R1=G |
| j=2  | `1`       | 1  | G      | 2G         | 1    | R0=G+G=2G? ❌ |

等等，让我们重新对齐：

更清晰的版本（从 MSB 开始，包含 MSB）：

### ✅ 推荐标准流程（包含 MSB）：

```text
R0 = O
R1 = G
for i from (n-1) downto 0:
    if k[i] == 0:
        R1 = R0 + R1
        R0 = 2 * R0
    else:
        R0 = R0 + R1
        R1 = 2 * R1
return R0
```

#### 验证：k = 5 = `101₂`

| i | k[i] | R0       | R1       | 操作                     |
|---|------|----------|----------|--------------------------|
| 2 | 1    | O        | G        | R0=O+G=G, R1=2G          |
| 1 | 0    | G        | 2G       | R1=G+2G=3G, R0=2G        |
| 0 | 1    | 2G       | 3G       | R0=2G+3G=5G, R1=6G       |
|   |      | **5G**   |          | ← 返回 R0 = 5G ✅        |

完美！


## 5. 安全性优势

| 攻击类型 | Montgomery Ladder 是否免疫？ |
|--------|--------------------------|
| **简单功耗分析（SPA）** | ✅ 是（恒定操作序列）|
| **差分功耗分析（DPA）** | ❌ 否（仍需掩码等防护）|
| **时序攻击** | ✅ 是（固定周期数）|
| **故障攻击（FA）** | ❌ 否（需错误检测）|

> ✅ 因此，它是 **安全 ECC 实现的基石**，但不是万能药。


## 6. 与其他算法对比

| 算法 | 速度 | 安全性 | 适用场景 |
|------|------|--------|--------|
| **Binary Method** | 快 | ❌ 不恒定时间 | 教学/非安全环境 |
| **Montgomery Ladder** | 中 | ✅ 恒定时间 | **通用安全实现** |
| **Fixed-Base Comb** | 极快 | ✅（若恒定）| 密钥生成（G 固定）|
| **wNAF** | 快 | ❌ 非恒定 | 软件（配合掩码）|

> 对于 **通用、安全、硬件友好** 的需求，**Montgomery Ladder 是首选**。


## 总结

- **Montgomery Ladder = 恒定时间 + 仅需点加/点倍 + 简单可靠**
- 每轮：**总是 1 次点加 + 1 次点倍**
- 返回 `R0` 即为 $ k \cdot G $
- 是构建 **安全 ECC IP 核** 的标准方法
