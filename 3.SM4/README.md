# SM4算法

SM4（原名SMS4）是中国国家密码管理局发布的**商用密码算法标准**之一，属于**对称加密算法**，主要用于无线局域网产品、金融IC卡、移动支付等场景。它于2012年3月被正式发布为国家密码行业标准（GM/T 0002-2012），并于2016年8月成为国家标准（GB/T 32907-2016）。

[GB/T 32907-2016标准](https://openstd.samr.gov.cn/bzgk/gb/newGbInfo?hcno=7803DE42D3BC5E80B0C3E5D8E873D56A&refer=outter)

### 一、基本特性

| 项目 | 内容 |
|------|------|
| 算法类型 | 分组密码（Block Cipher） |
| 分组长度 | 128 位（16 字节） |
| 密钥长度 | 128 位（16 字节） |
| 加密轮数 | 32 轮 |
| 结构 | 改进的 Feistel 网络（非平衡型） |
| [S盒](./doc/sbox.md) | 固定的 8-bit → 8-bit 非线性替换表（与 AES 不同） |
| 白化 | 加密前和解密后有初始/最终密钥加（XOR） |


### 二、算法结构简述

1. **把明文分成 4 段**：  
   将 16 字节明文按顺序分为 4 个 4 字节（32 位）的数据块，记作 A、B、C、D。

2. **开始 32 轮处理**：  
   每一轮都做类似的操作，但使用不同的轮密钥。以第 1 轮为例：

   - 把 B、C、D 这三段数据混合在一起（通过异或操作）。
   - 再把这个混合结果和**当前轮的轮密钥**混合。
   - 把结果送入**变换函数 T**
   - 最后，把这个处理完的结果和 A 段做异或，得到一个新值。
   - 然后把数据整体“向前滑动”：原来的 B 变成新的 A，C 变成 B，D 变成 C，而刚刚算出来的新值变成 D。

   > 下一轮就用新的 A、B、C、D 重复上述过程，但使用下一个轮密钥。

3. **重复 32 次**：  
   上述步骤共执行 32 轮，每轮都让数据变得更混乱、更难还原。

4. 变换函数T

   T 函数由两个子步骤组成：

   #### 1、S 盒非线性替换（τ 变换）
   - 输入一个 32 位的数据（即 4 个字节）。
   - 把这 4 个字节**分别独立地查 SM4 的 S 盒**（就是前面提到的那个固定 256 字节表）。
   - 每个字节被替换成另一个看似随机的字节。
   - 最后把 4 个新字节重新拼成一个 32 位的值。

   这一步是**唯一的非线性来源**，没有它，SM4 就容易被破解。

   #### 2、线性扩散变换（L 变换）
   - 对 S 盒输出的 32 位结果，进行**多次循环左移 + 异或**，让每一位的影响快速传播到整个字。
   - 具体操作（自然语言描述）：

   > 将 S 盒输出记为 B（32 位），则 L(B) 的计算方式为：  
   > **B ⊕ (B 循环左移 2 位) ⊕ (B 循环左移 10 位) ⊕ (B 循环左移 18 位) ⊕ (B 循环左移 24 位)**

   > 注意：这里用了 **4 次移位**（2、10、18、24），比密钥扩展中的 T' 更复杂，扩散更强。

### 三、[密钥扩展（轮密钥生成）](./doc/key.md)

- 主密钥 MK（128位）被分为 4 个 32 位字：MK = (MK₀, MK₁, MK₂, MK₃)
- 使用系统参数 FK（固定常量）和 CK（轮常量）生成 32 个轮密钥 RK₀ ~ RK₃₁
- 扩展过程也使用类似 T 函数的变换（但线性部分 L' 不同）


### 四、安全性

- SM4 抵抗已知的差分攻击、线性攻击等经典密码分析方法。
- 安全强度与 AES-128 相当。
- 已通过中国国家密码管理局认证，并在金融、政务等领域广泛应用。


### 五、应用场景

- 中国商用密码体系（如金融IC卡、数字证书、安全芯片）
- 国密 SSL/TLS（如 GM/T 0024-2014）
- 国产操作系统、数据库、加密机中的默认对称算法

