# S 盒

SM4 加密过程中的 **S盒（Substitution-box，替换盒）** 是整个算法中**唯一的非线性部件**，也是实现“混淆”（Confusion）的关键。它的作用是把输入的每一个字节（8 位）替换成另一个看似随机的字节，从而打乱数据与密钥之间的简单关系，增强抗攻击能力。

下面用**通俗、非公式化的方式**详细解释 SM4 的 S 盒：


### 一、S 盒的本质：一个固定的“查表字典”

- SM4 的 S 盒是一个 **256 字节的查找表**（因为 8 位输入共有 2⁸ = 256 种可能）。
- 输入一个字节（比如 `0xEF`），就去表里找对应的输出字节（比如 `0x84`）。
- 这个表是**公开的、固定的**，由中国国家密码管理局在标准中直接给出，所有 SM4 实现都必须使用同一个表。

> 换句话说：S 盒就像一本“密码翻译手册”，全世界的 SM4 程序都用同一本。


### 二、怎么查表？——行列定位法

虽然 S 盒是一个一维的 256 字节数组，但为了方便描述，通常把它画成一个 **16 行 × 16 列** 的表格：

- 输入字节的**高 4 位**（前半字节）决定**行号**；
- 输入字节的**低 4 位**（后半字节）决定**列号**；
- 表格交叉处的值就是输出。

#### 举个例子：
输入字节是 `0xEF`：
- 高 4 位是 `E`（十六进制，等于十进制 14）→ 第 14 行（从 0 开始数，即第 15 行）；
- 低 4 位是 `F`（=15）→ 第 15 列；
- 查表得该位置的值是 `0x84`；
- 所以：**S(0xEF) = 0x84**

> 这就是 SM4 标准文档中常说的：“S 盒以字节为单位进行非线性替换，输入高 4 位为行，低 4 位为列”。


### 三、S 盒在 SM4 中如何使用？

SM4 处理的是 32 位（4 字节）的数据块。在每一轮的变换中：

1. 先得到一个 32 位的中间值（由异或和轮密钥混合而来）；
2. 把这个 32 位数据**拆成 4 个独立的字节**（比如 `[b0, b1, b2, b3]`）；
3. **对每个字节分别查 S 盒**，得到 4 个新字节；
4. 再把这 4 个新字节**重新拼成一个 32 位的数据**，送入下一步（线性扩散）。

> 所以，SM4 的 S 盒实际上是 **4 个相同的 S 盒并行使用**，一次处理 4 字节。


### 四、S 盒数据

以下是 SM4 S 盒的开头几行（十六进制表示）：

```
     0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F
0 | D6 90 E9 FE CC E1 3D B7 16 B6 14 C2 28 FB 2C 05
1 | 2B 67 9A 76 2A BE 04 C3 AA 44 13 26 49 86 06 99
2 | 9C 42 50 F4 91 EF 98 7A 33 54 0B 43 ED CF AC 62
3 | E4 B3 1C A9 C9 08 E8 95 80 DF 94 FA 75 8F 3F A6
4 | 47 07 A7 FC F3 73 17 BA 83 59 3C 19 E6 85 4F A8
5 | 68 6B 81 B2 71 64 DA 8B F8 EB 0F 4B 70 56 9D 35
6 | 1E 24 0E 5E 63 58 D1 A2 25 22 7C 3B 01 21 78 87
7 | D4 00 46 57 9F D3 27 52 4C 36 02 E7 A0 C4 C8 9E
8 | EA BF 8A D2 40 C7 38 B5 A3 F7 F2 CE F9 61 15 A1
9 | E0 AE 5D A4 9B 34 1A 55 AD 93 32 30 F5 8C B1 E3
A | 1D F6 E2 2E 82 66 CA 60 C0 29 23 AB 0D 53 4E 6F
B | D5 DB 37 45 DE FD 8E 2F 03 FF 6A 72 6D 6C 5B 51
C | 8D 1B AF 92 BB DD BC 7F 11 D9 5C 41 1F 10 5A D8
D | 0A C1 31 88 A5 CD 7B BD 2D 74 D0 12 B8 E5 B4 B0
E | 89 69 97 4A 0C 96 77 7E 65 B9 F1 09 C5 6E C6 84
F | 18 F0 7D EC 3A DC 4D 20 79 EE 5F 3E D7 CB 39 48
```


### 五、为什么 S 盒很重要？

- **非线性**：如果没有 S 盒，整个 SM4 就只是一堆异或和移位，容易被数学方法破解。
- **雪崩效应**：输入改 1 位，S 盒输出可能完全不同，进而让最终密文剧烈变化。
- **抗差分/线性攻击**：S 盒经过精心设计，使得输入差异和输出差异之间没有明显统计规律。



### 总结

> **SM4 的 S 盒就是一个 256 字节的固定替换表，输入 1 个字节，输出 1 个字节，通过“高 4 位定行、低 4 位定列”来查表。它是 SM4 实现安全性的核心非线性组件。**
