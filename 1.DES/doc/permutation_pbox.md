# P 置换

DES 中的 **P 置换**（Permutation P-box）是每轮 Feistel 函数中 **S 盒输出之后、与左半部分异或之前** 的一个**固定位重排操作**。它的作用是对 S 盒产生的 32 位输出进行**扩散**（Diffusion），使得每一位的影响尽可能快速地 spread 到下一轮的多个 S 盒输入中。

## 一、基本功能

- **输入**：32 位（来自 8 个 S 盒的输出拼接）
- **输出**：32 位（位顺序被重新排列）
- **性质**：**固定置换**（无密钥参与，非线性由 S 盒提供，P 是线性的）
- **目的**：增强**扩散性**（Shannon 扩散原则）

> P 置换是 **可逆的**（因为是 1:1 位重排，无信息丢失）

## 二、P 置换表（标准 DES 定义）

P 表是一个包含 **32 个数字** 的列表，每个数字表示**输出位从输入的哪一位取值**（1-based 索引）。

### 完整 P 置换表：

```text
16,  7, 20, 21,
29, 12, 28, 17,
 1, 15, 23, 26,
 5, 18, 31, 10,
 2,  8, 24, 14,
32, 27,  3,  9,
19, 13, 30,  6,
22, 11,  4, 25
```

> 共 8 行 × 4 列 = 32 项

## 三、操作方式

设 S 盒输出为 32 位：  
`S_out = [s₁, s₂, s₃, ..., s₃₂]`（s₁ 是最左边/最高位，位置编号 1~32）

则 P 置换后的输出 `P_out = [p₁, p₂, ..., p₃₂]` 满足：

- `p₁ = s₁₆`
- `p₂ = s₇`
- `p₃ = s₂₀`
- ...
- `p₃₂ = s₂₅`

即：**P 表第 i 项的值 = 输入位的位置**

### 示例：
- 第 1 位输出 ← 输入的第 **16** 位
- 第 10 位输出 ← 输入的第 **15** 位（见表第 10 项）
- 第 32 位输出 ← 输入的第 **25** 位

## 四、密码学设计目的

P 置换的核心目标是实现 **“一次 S 盒输出的每一位，都能影响下一轮多个不同的 S 盒”**。

### 关键特性：
- **跨 S 盒扩散**：  
  S 盒输出的每一位经过 P 置换后，会被分配到 E 扩展后的**不同 6 位组**中，从而进入**不同的 S 盒**。
  
- **满足严格雪崩准则**（SAC）：  
  输入 1 位变化 → 经过几轮后，约 50% 输出位翻转。

- **配合 E 扩展形成“E-P 链”**：  
  P 的输出成为下一轮的 R，经 E 扩展后送入 S 盒。P 的设计确保当前轮 S 盒的输出能**均匀分散**到下一轮的所有 S 盒。

> 经典分析表明：**经过 2 轮 DES，1 位输入变化可影响所有 32 位输出**，这主要归功于 E 和 P 的协同设计。

## 五、总结

| 属性 | 说明 |
|------|------|
| 输入/输出 | 32 位 → 32 位 |
| 类型 | 固定位置换（线性） |
| 可逆性 | 是（用于解密时相同结构） |
| 核心作用 | 扩散（Diffusion） |
| 与 S 盒关系 | S 提供混淆（Confusion），P 提供扩散 |

## 补充：P 置换 vs 初始置换 IP

- **IP / IP⁻¹**：作用于明文/密文整体，**无密码学意义**，仅为历史兼容
- **P 置换**：作用于每轮内部，**具有重要安全意义**，是 DES 扩散机制的关键
