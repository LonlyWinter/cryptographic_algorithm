# IP 置换

DES 中的 **IP 置换**（Initial Permutation，初始置换）是 DES 加密流程的第一步，用于对 **64 位明文输入** 进行固定的位重排。尽管 IP 及其逆置换 IP⁻¹ **不提供任何密码学安全性**（因为它们是公开且无密钥的），但作为 DES 标准的一部分，所有实现都必须包含它。

## 一、基本功能

- **输入**：64 位明文（记为 M₁ 到 M₆₄）
- **输出**：64 位重排后的数据（进入 Feistel 网络）
- **性质**：固定、公开、可逆的位置换
- **目的**：历史原因（便于 1970 年代硬件实现），**无加密作用**

> 解密时，在 Feistel 网络之后需应用 **IP 的逆置换 IP⁻¹**（Final Permutation）

## 📋 二、IP 置换表（标准 DES 定义）

IP 表是一个包含 **64 个数字** 的列表，每个数字表示**输出的第 i 位来自输入的哪一位**（使用 **1-based 索引**）。

### 完整 IP 表（FIPS PUB 46）：

```text
58, 50, 42, 34, 26, 18, 10,  2,
60, 52, 44, 36, 28, 20, 12,  4,
62, 54, 46, 38, 30, 22, 14,  6,
64, 56, 48, 40, 32, 24, 16,  8,
57, 49, 41, 33, 25, 17,  9,  1,
59, 51, 43, 35, 27, 19, 11,  3,
61, 53, 45, 37, 29, 21, 13,  5,
63, 55, 47, 39, 31, 23, 15,  7
```

> 共 8 行 × 8 列 = 64 项

## 三、操作方式

设明文为 64 位：  
`M = [M₁, M₂, M₃, ..., M₆₄]`  
（通常 M₁ 是最左边/最高有效位，MSB）

则 IP 置换后的输出 `IP(M) = [P₁, P₂, ..., P₆₄]` 满足：

- `P₁ = M₅₈`
- `P₂ = M₅₀`
- `P₃ = M₄₂`
- ...
- `P₆₄ = M₇`

即：**IP 表第 i 项的值 = 原始明文的位位置**

### 示例：
- 输出第 1 位 ← 明文第 **58** 位
- 输出第 8 位 ← 明文第 **2** 位
- 输出第 64 位 ← 明文第 **7** 位

## 四、IP 的逆置换：IP⁻¹（Final Permutation）

在 16 轮 Feistel 迭代后，左右半部分交换（或不交换，视实现而定），然后应用 **IP⁻¹** 得到最终密文。

### IP⁻¹ 表（注意：不是简单倒序！）：

```text
40,  8, 48, 16, 56, 24, 64, 32,
39,  7, 47, 15, 55, 23, 63, 31,
38,  6, 46, 14, 54, 22, 62, 30,
37,  5, 45, 13, 53, 21, 61, 29,
36,  4, 44, 12, 52, 20, 60, 28,
35,  3, 43, 11, 51, 19, 59, 27,
34,  2, 42, 10, 50, 18, 58, 26,
33,  1, 41,  9, 49, 17, 57, 25
```

> 验证：若先做 IP，再做 IP⁻¹，结果等于原始输入。

## 五、示例（简化）

假设明文（十六进制）：  
`M = 0x0123456789ABCDEF`

1. 转为 64 位二进制（MSB first）：
   ```
   0000 0001 0010 0011 0100 0101 0110 0111
   1000 1001 1010 1011 1100 1101 1110 1111
   ```

2. 应用 IP：
   - 第 1 位输出 = 第 58 位 → 查得为 `1`
   - 第 2 位输出 = 第 50 位 → 查得为 `0`
   - …
   - 最终得到 IP(M)

3. 经过 16 轮 Feistel 后，再应用 IP⁻¹ → 得到密文

> 💡 实际上，许多软件实现会**将 IP 和 IP⁻¹ 与第一/最后一轮合并优化**，但逻辑等价。

## 六、重要说明

| 问题 | 说明 |
|------|------|
| **IP 是否增强安全性？** | ❌ 否。它是线性、公开、无密钥的，可被攻击者轻易逆向。 |
| **能否省略 IP？** | 理论上可以，但**不符合 DES 标准**，与其他实现不兼容。 |
| **为什么设计 IP？** | 据 IBM 工程师透露，是为了**适应 1970 年代硬件的数据加载方式**（如按列读取）。 |

## 七、总结

- **IP = 初始置换**，对明文进行固定重排
- **IP⁻¹ = 最终置换**，是 IP 的逆操作
- **两者都不涉及密钥，无加密强度贡献**
- **必须按标准实现以保证互操作性**
