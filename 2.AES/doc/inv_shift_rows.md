# 逆行移位（InvShiftRows）

**InvShiftRows（逆行移位）** 是 AES 解密过程中用于**撤销加密时 ShiftRows 操作**的逆变换。它的作用是对状态矩阵（State）的每一行进行**循环右移（Right Rotate）**，使得数据恢复到 ShiftRows 之前的位置。


## 一、回顾：加密时的 ShiftRows

在 AES **加密**中，ShiftRows 对第 `i` 行（0 ≤ i ≤ 3）执行**循环左移 `i` 字节**：

| 行号 | 加密操作（左移） |
|------|------------------|
| 0    | 0 位（不变）     |
| 1    | 1 位             |
| 2    | 2 位             |
| 3    | 3 位             |

例如第 3 行 `[a, b, c, d]` → `[d, a, b, c]`


## 二、InvShiftRows：解密时的操作

为还原上述变换，**InvShiftRows 对第 `i` 行执行循环右移 `i` 字节**（等价于左移 `(4 - i) % 4` 字节）：

| 行号 (i) | InvShiftRows 操作（循环右移 i 位） | 等效左移 |
|----------|-----------------------------------|--------|
| 0        | 不动                              | 0      |
| 1        | 右移 1 位                         | 左移 3 |
| 2        | 右移 2 位                         | 左移 2 |
| 3        | 右移 3 位                         | 左移 1 |

### 具体变换规则：

- **第 0 行**：`[a, b, c, d] → [a, b, c, d]`
- **第 1 行**：`[a, b, c, d] → [d, a, b, c]`
- **第 2 行**：`[a, b, c, d] → [c, d, a, b]`
- **第 3 行**：`[a, b, c, d] → [b, c, d, a]`

> 验证：若加密时 `[e2,43,91,c6]` 左移 1 → `[43,91,c6,e2]`，  
> 则解密时对 `[43,91,c6,e2]` 右移 1 → `[e2,43,91,c6]`，完全还原。


## 三、具体示例

假设某轮解密前的状态为（即加密后经过 MixColumns 和 AddRoundKey 的结果，现在要开始解密）：

```
da 12 4f e2
43 91 c6 e2
6d f4 4c 8f
ed 7d b0 33
```

这是 **加密过程中 ShiftRows 之后的状态**。现在解密时，首先要执行 **InvShiftRows** 来还原 ShiftRows。

逐行处理：

- **第 0 行**：`[da, 12, 4f, e2]` → 不变 → `[da, 12, 4f, e2]`
- **第 1 行**：`[43, 91, c6, e2]` → 右移 1 → `[e2, 43, 91, c6]`
- **第 2 行**：`[6d, f4, 4c, 8f]` → 右移 2 → `[4c, 8f, 6d, f4]`
- **第 3 行**：`[ed, 7d, b0, 33]` → 右移 3 → `[7d, b0, 33, ed]`

**InvShiftRows 后的状态**：

```
da 12 4f e2
e2 43 91 c6
4c 8f 6d f4
7d b0 33 ed
```

> 这正是加密时 **SubBytes 之后、ShiftRows 之前** 的状态！下一步将执行 **InvSubBytes**。


## 四、在 AES 解密流程中的位置

AES 解密的一般轮结构（以 AES-128 为例）：

1. **初始**：AddRoundKey（使用最后一轮密钥）
2. **每轮（共 10 轮）**：
   - 第 1~9 轮：  
     `InvShiftRows → InvSubBytes → AddRoundKey → InvMixColumns`
   - 第 10 轮（最后一轮）：  
     `InvShiftRows → InvSubBytes → AddRoundKey`（**无 InvMixColumns**）

> 注意：**InvShiftRows 是解密每轮的第一步**（除了初始 AddRoundKey）。


## 五、关键性质

| 性质 | 说明 |
|------|------|
| **可逆性** | `InvShiftRows(ShiftRows(X)) = X` |
| **无密钥** | 纯置换操作，不依赖密钥 |
| **高效** | 仅地址重排，硬件/软件开销极小 |
| **对称设计** | 加密左移 i，解密右移 i，完美对称 |


## 总结

> **InvShiftRows = 对状态矩阵第 i 行循环右移 i 个字节**

| 行 | 操作 |
|----|------|
| 0  | 不变 |
| 1  | `[a,b,c,d] → [d,a,b,c]` |
| 2  | `[a,b,c,d] → [c,d,a,b]` |
| 3  | `[a,b,c,d] → [b,c,d,a]` |

它是 AES 解密中恢复数据位置的关键一步，与 ShiftRows 严格互为逆操作。

