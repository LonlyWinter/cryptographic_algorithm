# 列混淆（MixColumns）
AES 的 **MixColumns**（列混淆）是 AES 加密过程中一个关键的线性变换步骤，用于在**每一轮（除最后一轮）**中增强扩散性（diffusion）。它作用于状态矩阵（State）的每一列，将每列的 4 个字节通过一个固定的矩阵乘法进行混合。

下面详细解释 **MixColumns 的具体操作原理、数学基础和计算示例**。


## 1. 状态矩阵（State）

AES 将 128 位（16 字节）的数据组织为一个 **4×4 的字节矩阵**，按列主序排列：

```
s00 s01 s02 s03
s10 s11 s12 s13
s20 s21 s22 s23
s30 s31 s32 s33
```

每一列是一个 4 字节向量：  
第 j 列 = `[s0j, s1j, s2j, s3j]^T`


## 2. MixColumns 操作（对每一列独立进行）

对每一列执行如下 **在 GF(2⁸) 上的矩阵乘法**：

$$
\begin{bmatrix}
s'_{0j} \\
s'_{1j} \\
s'_{2j} \\
s'_{3j}
\end{bmatrix}
=
\begin{bmatrix}
02 & 03 & 01 & 01 \\
01 & 02 & 03 & 01 \\
01 & 01 & 02 & 03 \\
03 & 01 & 01 & 02 \\
\end{bmatrix}
\times
\begin{bmatrix}
s_{0j} \\
s_{1j} \\
s_{2j} \\
s_{3j}
\end{bmatrix}
$$

> 所有运算在 **有限域 GF(2⁸)** 中进行，使用 AES 定义的不可约多项式：  
> **m(x) = x⁸ + x⁴ + x³ + x + 1**（十六进制表示为 `0x11b`）


## 3. 关键：GF(2⁸) 中的乘法

在 MixColumns 中，只涉及乘以常数 **01, 02, 03**。它们的含义如下：

- **× 01**：恒等操作（不变）
- **× 02**：左移 1 位；若最高位（bit 7）为 1，则异或 `0x1b`
- **× 03**：等于 `×02 ⊕ ×01`，即 `(a × 02) ⊕ a`

### 乘以 02 的快速实现（伪代码）：
```c
uint8_t xtime(uint8_t a) {
    return (a & 0x80) ? ((a << 1) ^ 0x1b) : (a << 1);
}
```

> 注意：`0x1b` 是 `0x11b` 去掉最高位（x⁸）后的低 8 位。


## 4. MixColumns 公式（逐字节）

对一列 `[a0, a1, a2, a3]`，输出列为 `[b0, b0, b2, b3]`：

```
b0 = (02·a0) ⊕ (03·a1) ⊕ (01·a2) ⊕ (01·a3)
b1 = (01·a0) ⊕ (02·a1) ⊕ (03·a2) ⊕ (01·a3)
b2 = (01·a0) ⊕ (01·a1) ⊕ (02·a2) ⊕ (03·a3)
b3 = (03·a0) ⊕ (01·a1) ⊕ (01·a2) ⊕ (02·a3)
```

所有“·”表示 GF(2⁸) 乘法，“⊕”是异或。


## 5. 官方示例（来自 FIPS-197）

考虑加密过程中的某一轮输入状态（在 SubBytes 和 ShiftRows 之后，MixColumns 之前）：

```
State before MixColumns:
d4 e0 b8 1e
bf b4 41 27
5d 52 11 98
30 ae f1 e5
```

我们对**第一列** `[d4, bf, 5d, 30]` 进行 MixColumns：

### 计算 b0：
- 02·d4 = xtime(0xd4)  
  - 0xd4 = 1101 0100 → 最高位为 1 → (0xd4 << 1) = 0xa8, 异或 0x1b → 0xa8 ^ 0x1b = **0xb3**
- 03·bf = xtime(0xbf) ⊕ 0xbf  
  - xtime(0xbf): 0xbf=10111111 → 左移=01111110=0x7e，因最高位为1 → 0x7e ^ 0x1b = **0x65**  
  - 0x65 ⊕ 0xbf = **da**
- 01·5d = 5d
- 01·30 = 30

→ b0 = 0xb3 ⊕ 0xda ⊕ 0x5d ⊕ 0x30  
= (b3 ⊕ da) = 69; (69 ⊕ 5d) = 34; (34 ⊕ 30) = **04**

b0 = **04**

类似地可算出其他字节，最终第一列变为 **[04, 66, 81, e5]**

完整 MixColumns 后的状态（FIPS-197 给出）：

```
State after MixColumns:
04 e0 48 28
66 cb f8 06
81 19 d3 26
e5 9a 7a 4c
```


## 6. 解密时的 InvMixColumns

解密时使用逆变换 **InvMixColumns**，其矩阵为：

$$
\begin{bmatrix}
0e & 0b & 0d & 09 \\
09 & 0e & 0b & 0d \\
0d & 09 & 0e & 0b \\
0b & 0d & 09 & 0e \\
\end{bmatrix}
$$

同样在 GF(2⁸) 中运算，但更复杂（需支持 ×09, ×0b, ×0d, ×0e）。


## 小结

| 特性 | 说明 |
|------|------|
| 作用 | 提供**列内字节的强扩散** |
| 轮次 | 加密中第 1 ~ 9 轮（AES-128），**最后一轮省略** |
| 数学 | GF(2⁸) 上的线性变换 |
| 核心操作 | 乘以 01/02/03 + 异或 |
| 可逆性 | 是，通过 InvMixColumns |
