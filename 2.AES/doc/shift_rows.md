# 行移位（ShiftRows）

AES 加密中的 **ShiftRows（行移位）** 是一个**简单的字节置换操作**，用于在状态矩阵（State）的**行方向上实现扩散（diffusion）**。它不改变任何字节的值，只改变它们的位置，使得后续的 MixColumns 能跨列混合不同原始位置的数据。

下面从 **原理、操作规则、示例、解密逆操作和代码** 五个方面详细说明。

## 一、基本原理

- **目的**：打破列之间的独立性，使单个字节的变化能影响到多个列。
- **方式**：对状态矩阵的每一行进行**循环左移（Left Rotate）**，不同行移动不同字节数。
- **特点**：
  - 无密钥参与（公开操作）
  - 可逆（解密时用 **InvShiftRows**，即循环右移）
  - 极低成本（仅地址重排）

## 二、状态矩阵结构回顾

AES 的状态（State）是一个 **4 行 × 4 列** 的字节矩阵：

```
s00 s01 s02 s03   ← 第 0 行
s10 s11 s12 s13   ← 第 1 行
s20 s21 s22 s23   ← 第 2 行
s30 s31 s32 s33   ← 第 3 行
```

> 注意：数据按**列优先**填充（明文第 0~3 字节 → 第 0 列，依此类推）。

## 三、ShiftRows 操作规则（加密）

对每一行 `i`（0 ≤ i ≤ 3），**循环左移 `i` 个字节**：

| 行号 (i) | 移位数 | 操作 |
|----------|--------|------|
| 0        | 0      | 不动 |
| 1        | 1      | `[s10, s11, s12, s13] → [s11, s12, s13, s10]` |
| 2        | 2      | `[s20, s21, s22, s23] → [s22, s23, s20, s21]` |
| 3        | 3      | `[s30, s31, s32, s33] → [s33, s30, s31, s32]` |

> 第 3 行左移 3 位 = 右移 1 位（因为 4 字节循环）。

### 变换后状态：

```
s00 s01 s02 s03    ← 不变
s11 s12 s13 s10    ← 左移 1
s22 s23 s20 s21    ← 左移 2
s33 s30 s31 s32    ← 左移 3
```

## 四、具体示例

假设 SubBytes 后的状态为（十六进制）：

```
da 12 4f e2
e2 43 91 c6
4c 8f 6d f4
7d b0 33 ed
```

逐行 ShiftRows：

- **第 0 行**：`[da, 12, 4f, e2]` → **不变**
- **第 1 行**：`[e2, 43, 91, c6]` → 左移 1 → `[43, 91, c6, e2]`
- **第 2 行**：`[4c, 8f, 6d, f4]` → 左移 2 → `[6d, f4, 4c, 8f]`
- **第 3 行**：`[7d, b0, 33, ed]` → 左移 3 → `[ed, 7d, b0, 33]`

**ShiftRows 后的新状态**：

```
da 12 4f e2
43 91 c6 e2
6d f4 4c 8f
ed 7d b0 33
```

> 下一步将进入 **MixColumns**（对每一列进行线性变换）。

## 五、解密时的逆操作：InvShiftRows

解密时需**撤销** ShiftRows，即对每行进行**循环右移 `i` 位**（等价于左移 `4−i` 位）：

| 行号 | InvShiftRows 操作 |
|------|-------------------|
| 0    | 不动 |
| 1    | 右移 1 → `[a,b,c,d] → [d,a,b,c]` |
| 2    | 右移 2 → `[a,b,c,d] → [c,d,a,b]` |
| 3    | 右移 3 → `[a,b,c,d] → [b,c,d,a]` |

> 或者理解为：第 i 行左移 `(4 - i) % 4` 位。

## 六、安全意义

- **扩散性**：使单个字节的变化在一轮内扩散到 4 个不同的列（经 MixColumns 后影响整列）。
- **与 MixColumns 协同**：ShiftRows 打破列边界，MixColumns 在列内混合，二者结合实现**雪崩效应**。
- **无代数结构**：纯置换，不引入新代数弱点。

## 总结

> **ShiftRows = 对状态矩阵的第 i 行循环左移 i 个字节**

| 行 | 移位 |
|----|------|
| 0  | 0    |
| 1  | 1    |
| 2  | 2    |
| 3  | 3    |

- 操作简单，但对扩散至关重要。
- 解密时用 [**InvShiftRows（循环右移）**](./inv_shift_rows.md) 撤销。
- 是 AES 实现高效并行的关键之一（无数据依赖）。
